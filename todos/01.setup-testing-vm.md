# Setting Up Google Compute Engine for Ruminer Testing

## Set Up Your GCP Project [DONE]
```
# Install gcloud CLI if not already installed
# For macOS:
brew install --cask google-cloud-sdk

# Initialize gcloud and authenticate
gcloud init
gcloud auth login

# Create a new project (optional if you already have one)
gcloud projects create ruminer-testing --name="Ruminer Testing"

# Set the project as active
gcloud config set project ruminer-testing
```

## Create a Compute Engine Instance [DONE]
```
# Create a VM instance with sufficient resources
gcloud compute instances create ruminer-test-vm \
  --zone=us-central1-a \
  --machine-type=e2-standard-4 \
  --boot-disk-size=50GB \
  --image-family=ubuntu-2004-lts \
  --image-project=ubuntu-os-cloud \
  --tags=http-server,https-server \
  --metadata=startup-script='#!/bin/bash
    apt-get update
    apt-get install -y git docker.io docker-compose-plugin
    systemctl enable docker
    systemctl start docker
    usermod -aG docker $USER
    curl -fsSL https://deb.nodesource.com/setup_18.x | bash -
    apt-get install -y nodejs
    npm install -g yarn'
```

## Set Up Firewall Rules [DONE]
```
# Allow HTTP and HTTPS traffic
gcloud compute firewall-rules create allow-http \
  --allow tcp:80 \
  --target-tags=http-server

gcloud compute firewall-rules create allow-https \
  --allow tcp:443 \
  --target-tags=https-server

# Allow custom ports for development
gcloud compute firewall-rules create allow-dev-ports \
  --allow tcp:3000,tcp:4000,tcp:9090 \
  --target-tags=http-server
```

## Connect to Your Instance [DONE]
```
# Connect via SSH
gcloud compute ssh ruminer-test-vm --zone=us-central1-a
```

## Set Up the Environment on the VM [DONE]
Once connected to the VM, run these commands:
```
# Clone your repository
git clone https://github.com/atmaware/ruminer.git
cd ruminer/self-hosting

# Run the setup script
sudo ./setup.sh
```

During the first deployment ruminer-migrate will go through and set up the necessary Postgres tables. 

## Access the Application [DONE]
From your local machine, you can access the application using the VM's external IP:

```bash
# Get the external IP of your VM
gcloud compute instances describe ruminer-test-vm --zone=us-central1-a --format='get(networkInterfaces[0].accessConfigs[0].natIP)'
```

Then access:

- Web app: http://[VM-EXTERNAL-IP]:3000
- API: http://[VM-EXTERNAL-IP]:4000

## Testing the Web Frontend [DONE]
```bash
# Connect to the VM
gcloud compute ssh ruminer-test-vm --zone=us-central1-a

# Check logs
docker compose logs -f web
```

## Testing the API [DONE]
```bash
# Check logs
curl http://localhost:4000/healthcheck

# Test API endpoints
curl -X POST http://localhost:4000/api/graphql -H "Content-Type: application/json" -d '{"query": "query { hello }"}'
```

## Testing Content Fetching [DONE]
```bash
# Check logs
docker compose logs -f content-fetch

# Test saving a URL (from inside the VM)
curl -X POST http://localhost:4000/graphql \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_JWT_TOKEN" \
  -d '{"query": "mutation { savePage(input: {url: \"[https://example.com](https://example.com)\"}) { ... on SavePageSuccess { clientRequestId } } }"}'
```

## Monitoring and Debugging [DONE]
```bash
# View logs for all services
docker compose logs -f

# Check database status
# List tables in the database
docker compose exec postgres psql -U postgres -d ruminer -c "\d"

# Check Redis status
docker compose exec redis redis-cli ping
```

## Setup Domain Name [DONE]

Add an A record:
- Type: A
- Host/Name: ruminer
- Value/Points to: 34.29.124.72 (your VM's IP address)
- TTL: 3600 (or as recommended by your registrar)

Visit https://ruminer.atmaware.com and login with:
- Email: demo@ruminer.app
- Password: demo_password
