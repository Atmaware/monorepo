# CI/CD Setup

## Set Up GitHub Secrets
First, you need to add these secrets to your GitHub repository:

Go to your GitHub repository → Settings → Secrets and variables → Actions
Add the following secrets:
```
GCP_PROJECT_ID: big-sunup-456806-a0
GCP_SA_KEY: (Your service account key JSON)
DB_PASSWORD: (A secure password for PostgreSQL)
JWT_SECRET: (A secure secret for JWT tokens)
VM_IP: 34.29.124.72
VM_USERNAME: (Your VM username, likely your Google username)
```

## Create a Service Account for GitHub Actions
```
# Create a service account for GitHub Actions
gcloud iam service-accounts create github-actions --display-name="GitHub Actions"

# Grant necessary permissions
gcloud projects add-iam-policy-binding big-sunup-456806-a0 \
  --member="serviceAccount:github-actions@big-sunup-456806-a0.iam.gserviceaccount.com" \
  --role="roles/compute.admin"

gcloud projects add-iam-policy-binding big-sunup-456806-a0 \
  --member="serviceAccount:github-actions@big-sunup-456806-a0.iam.gserviceaccount.com" \
  --role="roles/storage.admin"

# Create and download a key
gcloud iam service-accounts keys create gcp-key.json \
  --iam-account=github-actions@big-sunup-456806-a0.iam.gserviceaccount.com
```

Copy the contents of gcp-key.json to the GCP_SA_KEY GitHub secret.

## Configure Your VM for Docker Compose
SSH into your VM and make sure Docker and Docker Compose are properly set up:
```
# Connect to your VM
gcloud compute ssh ruminer-test-vm --zone=us-central1-a

# Install Docker Compose v2 if not already installed
sudo apt-get update
sudo apt-get install -y docker-compose-plugin
```

## Set Up Container Registry Access
Ensure your VM can pull from Google Container Registry:
```
# On your VM
sudo gcloud auth configure-docker
```

## Test the Workflow
You can manually trigger the workflow to test it:

Go to your GitHub repository → Actions
Select the "Deploy to GCE" workflow
Click "Run workflow"

## How the CI/CD Pipeline Works
1. Trigger: The workflow runs when you push to the main branch (except for changes to Apple/Android code or markdown files) or when manually triggered.
2. Build Phase:
- Checks out your code
- Sets up Google Cloud SDK
- Builds Docker images for API, web, and content-fetch services
- Pushes images to Google Container Registry
3. Deploy Phase:
- Generates a docker-compose.yml file with your configuration
- Copies it to your VM
- Pulls the latest images on the VM
- Restarts all services
- Runs database migrations

## Customizing the Deployment
You can modify the deploy-to-gce.yml file to:

1. Add more services
2. Configure environment variables
3. Set up SSL with Let's Encrypt
4. Add monitoring or logging services

## Troubleshooting
If you encounter issues:

1. Check the GitHub Actions logs for detailed error messages
2. SSH into your VM and check Docker logs: sudo docker-compose logs
3. Verify that all secrets are correctly set in GitHub
4. Ensure your service account has sufficient permissions